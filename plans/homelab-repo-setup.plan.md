# Homelab Server Repo — Подготовка репозитория для развёртывания на miniPC

**Status**: `complete`

## Problem Statement
Создать полностью самодостаточный репозиторий для self-hosted сервера, который можно будет перенести на miniPC и развернуть одной командой. Репозиторий должен быть единственным источником правды для конфигурации, содержать весь стек сервисов, скрипты деплоя/бэкапа и документацию.

## Problem Analysis
Я разбил эту задачу на логические блоки, каждый из которых приносит конкретную ценность:

1. **Фундамент репозитория** — структура, README, .gitignore. Без этого нельзя начать работу.
2. **Docker Compose стек** — сердце системы, определяет все сервисы и их взаимодействия.
3. **Конфигурация Caddy** — единая точка входа, делает все сервисы доступными через один порт.
4. **Env-шаблон** — документирует, какие переменные нужны сервисам, без раскрытия секретов.
5. **Скрипты деплоя и валидации** — делают развёртывание однострочным (`./scripts/deploy.sh`).
6. **Бэкап и restore-test** — критически важная часть, гарантирует, что данные не потеряются.
7. **systemd и Docker daemon config** — автоматизация бэкапов и управление логами.
8. **Документация** — runbooks для обслуживания, обновления и восстановления.

Каждый шаг независим и может быть выполнен отдельно, но вместе они создают надёжную систему, которую можно развернуть и обслуживать.

## Questions Resolved

Пока нет нерешённых вопросов. Требования заданы чётко, стек зафиксирован.

## Edge Cases & Considerations

- [ ] **Проверка на секреты** → validate.sh должен блокировать коммит .env файлов
- [ ] **Версии Docker образов** → использовать только фиксированные теги, never latest
- [ ] **Идемпотентность деплоя** → повторный запуск deploy.sh не должен ломать систему
- [ ] **Restore-test должен оставаться чистым** → после себя удалять времённые контейнеры и данные
- [ ] **Логи Docker** → ограничить размер, чтобы не забить диск
- [ ] **Caddy работает по IP** → не требовать домена, использовать path-based routing

## Relevant Context

Текущее состояние репозитория:
- `CLAUDE.md` — инструкции для AI-агента (уже существует)
- `.git/` — git репозиторий (уже инициализирован)

## Feature Steps

> **Note**: Шаги описывают пользовательские истории и бизнес-ценность, а не технические детали реализации.

### Шаг 1: Фундамент репозитория (структура и документация)

**Business Value**: Создаёт понятную структуру проекта и защищает от случайного попадания секретов в git.

**Depends on**: none

**Definition of Done**:
- [ ] Создана директория структура: compose/, caddy/, scripts/, infra/, systemd/, docs/
- [ ] .gitignore исключает .env, data/, backups/, *.log, *.db, *.sqlite*
- [ ] README.md содержит: цель проекта, список сервисов, путь на сервере (/srv/homelab/homelab-server), команду запуска
- [ ] Структура соответствует шаблону из задания (секция 3.1)

**Touches**: 所有 директории и файлы фундамента

---

### Шаг 2: Docker Compose стек с сервисами

**Business Value**: Определяет все сервисы системы, их взаимодействие и хранение данных. Это "сердце" инфраструктуры.

**Depends on**: none

**Definition of Done**:
- [ ] compose/compose.yml существует и содержит все сервисы (caddy, vaultwarden, syncthing, filebrowser, uptime-kuma)
- [ ] Все образы используют фиксированные теги (нет latest)
- [ ] Единственный порт, открытый наружу: 80:80 у Caddy
- [ ] Все stateful сервисы используют volumes в /srv/data/<service>
- [ ] docker compose -f compose/compose.yml config проходит без ошибок
- [ ] Создана internal network для коммуникации сервисов

**Touches**: compose/compose.yml

---

### Шаг 3: Env-шаблон с документацией переменных

**Business Value**: Документирует все необходимые переменные окружения и служит шаблоном для создания реального .env на сервере.

**Depends on**: Шаг 2

**Definition of Done**:
- [ ] compose/.env.example содержит все переменные для сервисов и бэкапа
- [ ] В .env.example нет реальных секретов, только плейсхолдеры
- [ ] Переменные охватывают: BASE_URL, VAULTWARDEN_*, FILEBROWSER_*, RESTIC_*

**Touches**: compose/.env.example

---

### Шаг 4: Reverse proxy конфигурация (Caddy)

**Business Value**: Обеспечивает единый вход в систему (port 80) и path-based routing ко всем сервисам.

**Depends on**: Шаг 2

**Definition of Done**:
- [ ] caddy/Caddyfile существует
- [ ] Caddy слушает :80
- [ ] Настроены роуты: /vault/*, /sync/*, /files/*, /status/*
- [ ] На корневом пути / отдаётся landing page со ссылками
- [ ] Конфиг работает без домена (по IP)

**Touches**: caddy/Caddyfile

---

### Шаг 5: Скрипт валидации репозитория (с security-проверками)

**Business Value**: Позволяет локально проверить корректность repo и обнаружить случайно попавшие секреты без доступа к серверу.

**Depends on**: Шаги 1-4

**Definition of Done**:
- [ ] scripts/validate.sh существует и исполняемый
- [ ] Проверяет наличие обязательных файлов
- [ ] Проверяет docker compose config
- [ ] Проверяет отсутствие latest в образах
- [ ] Проверяет, что compose/.env не в git
- [ ] **Security-проверки**:
  - [ ] Сканирует файлы на паттерны секретов (API ключи, токены, пароли)
  - [ ] Проверяет, что нет .env файлов (кроме .env.example)
  - [ ] Проверяет, что секреты не хардкодены в compose.yml
  - [ ] Проверяет отсутствие файлов с секретами в git
- [ ] Возвращает 0 на валидном repo, понятные ошибки при нарушениях

**Touches**: scripts/validate.sh

---

### Шаг 6: Скрипт деплоя

**Business Value**: Делает развёртывание системы однострочным: `./scripts/deploy.sh`

**Depends on**: Шаги 2-5

**Definition of Done**:
- [ ] scripts/deploy.sh существует и исполняемый
- [ ] Проверяет наличие compose/.env
- [ ] Запускает стек через docker compose up -d
- [ ] Выводит статус контейнеров
- [ ] Вызывает healthcheck.sh после деплоя
- [ ] Идемпотентен (повторный запуск не ломает систему)

**Touches**: scripts/deploy.sh

---

### Шаг 7: Healthcheck скрипт

**Business Value**: Позволяет быстро проверить работоспособность всех сервисов после деплоя или изменений.

**Depends on**: Шаг 6

**Definition of Done**:
- [ ] scripts/healthcheck.sh существует и исполняемый
- [ ] Проверяет все endpoints: /, /vault/, /sync/, /files/, /status/
- [ ] Возвращает 0 только если все отвечают 2xx/3xx
- [ ] При ошибке указывает, что именно недоступно

**Touches**: scripts/healthcheck.sh

---

### Шаг 8: Backup скрипт с Restic

**Business Value**: Гарантирует, что данные всех сервисов надёжно сохранены и можно восстановиться после сбоя.

**Depends on**: Шаг 3

**Definition of Done**:
- [ ] scripts/backup.sh существует и исполняемый
- [ ] Проверяет наличие RESTIC_REPO и RESTIC_PASSWORD
- [ ] Бэкапит /srv/data/vaultwarden и /srv/homelab/homelab-server (исключая .env)
- [ ] Выполняет restic forget --prune по политике (7 daily, 4 weekly, 6 monthly)
- [ ] Логирует в /srv/data/backup/backup.log
- [ ] Не содержит секретов

**Touches**: scripts/backup.sh

---

### Шаг 9: Restore-test скрипт

**Business Value**: Проверяет, что бэкап реально работает и данные можно восстановить.

**Depends on**: Шаг 8

**Definition of Done**:
- [ ] scripts/restore_test.sh существует и исполняемый
- [ ] Восстанавливает последний бэкап во временную директорию
- [ ] Запускает временный контейнер с восстановленными данными
- [ ] Проверяет доступность endpoint
- [ ] Очищает времённые контейнеры и данные после проверки
- [ ] Сохраняет лог диагностики при падении

**Touches**: scripts/restore_test.sh

---

### Шаг 10: systemd units для автоматизации бэкапа

**Business Value**: Обеспечивает автоматический ежедневный бэкап без участия человека.

**Depends on**: Шаг 8

**Definition of Done**:
- [ ] systemd/homelab-backup.service существует (вызывает backup.sh)
- [ ] systemd/homelab-backup.timer существует (ежедневный запуск в 03:00)
- [ ] systemd/homelab-restore-test.service существует (для ручного запуска)
- [ ] Пути соответствуют /srv/homelab/homelab-server
- [ ] Файлы готовы для копирования в /etc/systemd/system/

**Touches**: systemd/homelab-backup.service, systemd/homelab-backup.timer, systemd/homelab-restore-test.service

---

### Шаг 11: Docker daemon конфигурация

**Business Value**: Предотвращает переполнение диска логами Docker.

**Depends on**: none

**Definition of Done**:
- [ ] infra/docker/daemon.json существует
- [ ] Ограничивает размер лог-файлов (max-size, max-file)
- [ ] В документации описано применение на сервере

**Touches**: infra/docker/daemon.json

---

### Шаг 12: Документация (runbooks)

**Business Value**: Позволяет любому (включая будущего себя) быстро понять, как развернуть, обслуживать и восстанавливать систему.

**Depends on**: Шаги 1-11

**Definition of Done**:
- [ ] docs/01_repo_overview.md — структура repo, сервисы, хранение данных, секреты
- [ ] docs/03_deploy.md — команды деплоя, порядок действий
- [ ] docs/04_backup_restore.md — инициализация restic, ручной бэкап, restore-test
- [ ] docs/05_operations.md — обновление контейнеров, логи, перезапуск
- [ ] docs/06_troubleshooting.md — типичные проблемы и решения
- [ ] Все документы содержат конкретные команды, а не общие слова
- [ ] Команды согласованы с путями /srv/homelab/homelab-server и /srv/data

**Touches**: docs/*.md

---

## Testing Strategy

Выбранная стратегия: **Локальная валидация + Security-проверки**

### Что проверяется:

1. **Локальная валидация** — запускается `./scripts/validate.sh`
   - Проверка наличия обязательных файлов
   - Валидация Docker Compose конфигурации (`docker compose config`)
   - Проверка на `latest` в образах
   - Проверка, что `compose/.env` не в git

2. **Security-проверки** — встроены в `validate.sh`
   - Сканирование на потенциальные секреты в файлах (ключи, пароли, токены)
   - Проверка, что в репозитории нет `.env` файлов (кроме `.env.example`)
   - Проверка, что секреты не хардкодены в `compose.yml` или скриптах
   - Проверка прав доступа к чувствительным файлам

3. **Финальная проверка** — перед завершением работы
   - Все файлы из секции 3.1 находятся на месте
   - `docker compose config` проходит без ошибок
   - `./scripts/validate.sh` возвращает 0
   - `git status` не показывает нежелательных файлов

### Что НЕ проверяется (требует сервера):

- Реальный запуск контейнеров
- Доступность HTTP endpoints
- Работа бэкапа и restore-test
- Интеграция между сервисами

Эти проверки будут выполнены на сервере при реальном деплое.

## Notes

Пока нет заметок. Буду добавлять по мере выполнения.
