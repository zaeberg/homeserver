services:
  caddy:
    image: caddy:2.7.6
    container_name: homelab-caddy
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - /srv/data/caddy/data:/data
      - /srv/data/caddy/config:/config
    networks:
      - internal
      - public
    healthcheck:
      test: ["CMD", "caddy", "validate", "--config", "/etc/caddy/Caddyfile"]
      interval: 30s
      timeout: 10s
      retries: 3

  vaultwarden:
    image: vaultwarden/server:1.30.1
    container_name: homelab-vaultwarden
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - /srv/data/vaultwarden:/data
    environment:
      - DOMAIN=${BASE_URL}
    networks:
      - internal
    expose:
      - 80
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/alive"]
      interval: 30s
      timeout: 10s
      retries: 3

  syncthing:
    image: syncthing/syncthing:1.27.3
    container_name: homelab-syncthing
    restart: unless-stopped
    hostname: syncthing
    volumes:
      - /srv/data/syncthing:/var/syncthing
    environment:
      - PUID=1000
      - PGID=1000
    networks:
      - internal
    expose:
      - 8384
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8384/rest/system/status"]
      interval: 30s
      timeout: 10s
      retries: 3

  filebrowser:
    image: filebrowser/filebrowser:v2.23.0
    container_name: homelab-filebrowser
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - /srv/data/filebrowser:/srv
      - /srv/data:/data
    environment:
      - FB_BASEURL=/files
    networks:
      - internal
    expose:
      - 80
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: >
      /filebrowser
      --address 0.0.0.0
      --port 80
      --baseurl /files
      --database /srv/filebrowser.db
      --root /data

  uptime-kuma:
    image: louislam/uptime-kuma:1.23.11
    container_name: homelab-uptime-kuma
    restart: unless-stopped
    volumes:
      - /srv/data/uptime-kuma:/app/data
    networks:
      - internal
    expose:
      - 3001
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  internal:
    driver: bridge
    internal: true
  public:
    driver: bridge
