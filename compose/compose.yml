# =============================================================================
# Docker Compose стек Homeserver
# =============================================================================
# Основные сервисы инфраструктуры: Traefik (reverse proxy), mDNS publisher, Homepage.
# Для добавления новых сервисов см. docs/07_adding_services.md
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Traefik - Reverse Proxy
  # ---------------------------------------------------------------------------
  # Единая точка входа для всех HTTP/HTTPS запросов к сервисам.
  # Автоматически обнаруживает Docker контейнеры через labels и маршрутизирует
  # запросы по hostname.
  #
  # Dashboard: http://traefik.home.local/dashboard/
  # Docs: https://doc.traefik.io/traefik/
  # ---------------------------------------------------------------------------
  traefik:
    image: traefik:v3.6.7  # Фиксированная версия для стабильности

    container_name: homelab-traefik

    restart: unless-stopped

    ports:
      - "80:80"      # HTTP - входящие запросы
      - "443:443"    # HTTPS - для будущего использования с Let's Encrypt
      - "8080:8080"  # Dashboard - только для локальной сети (firewall!)

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - /srv/data/traefik/letsencrypt:/letsencrypt

    networks:
      - internal  # Внутренняя сеть для общения с сервисами
      - public    # Публичная сеть для приёма внешних запросов

    labels:
      # mDNS/Bonjour labels (для traefik-avahi-helper)
      - "avahi.homeserver.service=Traefik Dashboard"
      - "avahi.homeserver.protocol=http"

      # Traefik labels (self-routing для dashboard'а)
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.home.local`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=web"

    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------------------------------------------------------------------------
  # traefik-avahi-helper - mDNS/Bonjour Publisher
  # ---------------------------------------------------------------------------
  # Публикует Docker контейнеры в локальной сети через mDNS/Bonjour.
  # Позволяет обращаться к сервисам по именам вида *.home.local без DNS.
  #
  # Requirements:
  #   - avahi-daemon должен быть установлен на хосте
  #   - /var/run/avahi-daemon/socket должен быть доступен
  # Docs: https://github.com/hardillb/traefik-avahi-helper
  # ---------------------------------------------------------------------------
  traefik-avahi:
    image: hardillb/traefik-avahi-helper:latest

    container_name: homelab-traefik-avahi-helper

    restart: unless-stopped

    hostname: avahi-helper

    # IPC и security настройки (требуются для avahi)
    ipc: host
    security_opt:
      - apparmor:unconfined
      - seccomp:unconfined
    cap_add:
      - NET_ADMIN
      - NET_RAW

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket
      - /var/run/dbus/system_bus_socket:/var/run/dbus/system_bus_socket

    networks:
      - internal

    environment:
      - HOSTNAME=home
      - DOMAIN=.local

  # ---------------------------------------------------------------------------
  # Homepage - Dashboard / Landing Page
  # ---------------------------------------------------------------------------
  # Главная страница homelab с навигацией по всем сервисам.
  # Config: compose/homepage/config/ (хранится в репозитории)
  # Docs: https://gethomepage.dev/
  # ---------------------------------------------------------------------------
  homepage:
    image: gethomepage/homepage:v1.9.0

    container_name: homelab-homepage

    restart: unless-stopped

    volumes:
      - ./homepage/config:/app/config:ro  # Конфиги из репозитория (read-only)

    environment:
      - HOMEPAGE_ALLOWED_HOSTS=home.local

    networks:
      - internal

    labels:
      # mDNS/Bonjour labels
      - "avahi.homeserver.service=Homepage"
      - "avahi.homeserver.protocol=http"

      # Traefik labels (routing)
      - "traefik.enable=true"
      - "traefik.http.routers.homepage.rule=Host(`home.local`)"
      - "traefik.http.services.homepage.loadbalancer.server.port=3000"
      - "traefik.http.routers.homepage.entrypoints=web"

    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  # Glances - System Monitoring
  # ---------------------------------------------------------------------------
  # Мониторинг ресурсов сервера в реальном времени (CPU, RAM, диск, сеть, процессы).
  # Config: compose/glances/glances.conf
  # Docs: https://glances.readthedocs.io/
  # ---------------------------------------------------------------------------
  glances:
    image: nicolargo/glances:4.4.1

    container_name: homelab-glances

    restart: unless-stopped

    # PID mode: host - обязательно для мониторинга всех процессов хост-системы
    # Без этого Glances будет видеть только свои собственные процессы
    pid: "host"

    # volumes для доступа к метрикам хоста
    volumes:
      - /:/rootfs:ro                                    # root filesystem (только чтение)
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Docker socket для мониторинга контейнеров
      - ./glances/glances.conf:/glances/conf/glances.conf:ro  # Конфигурационный файл
      - /etc/os-release:/etc/os-release:ro # для корректного отображения информации о дистрибутиве

    # временная файловая система в памяти
    tmpfs:
      - /tmp

    environment:
      - TZ=Europe/Kaliningrad                          # Часовой пояс
      - GLANCES_OPT=-C /glances/conf/glances.conf -w   # -C = конфиг, -w = web-режим
      - PYTHONPYCACHEPREFIX=/tmp/py_caches             # Кэш Python в /tmp (read-only FS)

    networks:
      - internal

    labels:
      # mDNS/Bonjour labels
      - "avahi.homeserver.service=Glances System Monitor"
      - "avahi.homeserver.protocol=http"

      # Traefik labels (routing)
      - "traefik.enable=true"
      - "traefik.http.routers.glances.rule=Host(`glances.home.local`)"
      - "traefik.http.services.glances.loadbalancer.server.port=61208"
      - "traefik.http.routers.glances.entrypoints=web"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:61208/api/4/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# =============================================================================
# Networks - Сети Docker
# =============================================================================

networks:
  # Internal Network - Внутренняя изолированная сеть (без интернета)
  # Все сервисы подключены к этой сети, Traefik маршрутизирует запросы
  internal:
    driver: bridge
    internal: true

  # Public Network - Для внешних запросов (когда будет настроен HTTPS)
  public:
    driver: bridge
