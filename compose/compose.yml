# =============================================================================
# Docker Compose стек Homeserver
# =============================================================================
# Основные сервисы инфраструктуры: Traefik (reverse proxy), mDNS publisher, Homepage.
# Для добавления новых сервисов см. docs/07_adding_services.md
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Traefik - Reverse Proxy
  # ---------------------------------------------------------------------------
  # Единая точка входа для всех HTTP/HTTPS запросов к сервисам.
  # Автоматически обнаруживает Docker контейнеры через labels и маршрутизирует
  # запросы по hostname.
  #
  # Dashboard: http://traefik.home.local/dashboard/
  # Docs: https://doc.traefik.io/traefik/
  # ---------------------------------------------------------------------------
  traefik:
    image: traefik:v3.6.7  # Фиксированная версия для стабильности

    container_name: homelab-traefik

    restart: unless-stopped

    ports:
      - "80:80"      # HTTP - входящие запросы
      - "443:443"    # HTTPS - для будущего использования с Let's Encrypt
      - "8080:8080"  # Dashboard - только для локальной сети (firewall!)

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - /srv/data/traefik/letsencrypt:/letsencrypt

    networks:
      - internal  # Внутренняя сеть для общения с сервисами
      - public    # Публичная сеть для приёма внешних запросов

    labels:
      # mDNS/Bonjour labels (для traefik-avahi-helper)
      - "avahi.homeserver.service=Traefik Dashboard"
      - "avahi.homeserver.protocol=http"

      # Traefik labels (self-routing для dashboard'а)
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.home.local`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=web"

    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------------------------------------------------------------------------
  # traefik-avahi-helper - mDNS/Bonjour Publisher
  # ---------------------------------------------------------------------------
  # Публикует Docker контейнеры в локальной сети через mDNS/Bonjour.
  # Позволяет обращаться к сервисам по именам вида *.home.local без DNS.
  #
  # Requirements:
  #   - avahi-daemon должен быть установлен на хосте
  #   - /var/run/avahi-daemon/socket должен быть доступен
  # Docs: https://github.com/hardillb/traefik-avahi-helper
  # ---------------------------------------------------------------------------
  traefik-avahi:
    image: hardillb/traefik-avahi-helper:latest

    container_name: homelab-traefik-avahi-helper

    restart: unless-stopped

    hostname: avahi-helper

    # IPC и security настройки (требуются для avahi)
    ipc: host
    security_opt:
      - apparmor:unconfined
      - seccomp:unconfined
    cap_add:
      - NET_ADMIN
      - NET_RAW

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket
      - /var/run/dbus/system_bus_socket:/var/run/dbus/system_bus_socket

    networks:
      - internal

    environment:
      - HOSTNAME=home
      - DOMAIN=.local

  # ---------------------------------------------------------------------------
  # Homepage - Dashboard / Landing Page
  # ---------------------------------------------------------------------------
  # Главная страница homelab с навигацией по всем сервисам.
  # Config: /srv/data/homepage/config/
  # Docs: https://gethomepage.dev/
  # ---------------------------------------------------------------------------
  homepage:
    image: ghcr.io/gethomepage/homepage:latest

    container_name: homelab-homepage

    restart: unless-stopped

    volumes:
      - /srv/data/homepage/config:/app/config

    environment:
      - HOMEPAGE_ALLOWED_HOSTS=home.local

    networks:
      - internal

    labels:
      # mDNS/Bonjour labels
      - "avahi.homeserver.service=Homepage"
      - "avahi.homeserver.protocol=http"

      # Traefik labels (routing)
      - "traefik.enable=true"
      - "traefik.http.routers.homepage.rule=Host(`home.local`)"
      - "traefik.http.services.homepage.loadbalancer.server.port=3000"
      - "traefik.http.routers.homepage.entrypoints=web"

    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# =============================================================================
# Networks - Сети Docker
# =============================================================================

networks:
  # Internal Network - Внутренняя изолированная сеть (без интернета)
  # Все сервисы подключены к этой сети, Traefik маршрутизирует запросы
  internal:
    driver: bridge
    internal: true

  # Public Network - Для внешних запросов (когда будет настроен HTTPS)
  public:
    driver: bridge
